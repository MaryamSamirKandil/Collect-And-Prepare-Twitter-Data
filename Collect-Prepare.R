getwd() ## Where am I ? "Default is Documents"
setwd("C:/Users/amani/Desktop/Workshop") ## Go to folder

####call libraries####

## To install libraries use

install.packages('sp')

library(twitteR)
library(RJSONIO)
library(bitops)
library(ROAuth) 
library(RCurl) 
library(stringi)
library(streamR) 
library(rJava) 
library(xlsxjars)
library(xlsx) 
library(readr)
library(rjson)
library(arabicStemR)
library(NLP)
library(tm)
library(sp)
library(RColorBrewer)
library(wordcloud)

####Authentication####
requestURL = "https://api.twitter.com/oauth/request_token"
accessURL = "https://api.twitter.com/oauth/access_token"
authURL = "https://api.twitter.com/oauth/authorize"

##Get keys from here https://apps.twitter.com/
consumerkey = "Your Consumer Key"
consumersecret = "Your Consumer Secret"

##Apply authenticate
my_oauth = OAuthFactory$new(consumerKey = consumerkey,
                            consumerSecret = consumersecret,
                            requestURL = requestURL,
                            accessURL = accessURL,
                            authURL = authURL)
my_oauth$handshake(curl=getCurlHandle())

##Save authentication
save(my_oauth, file = "myOauth.Rdata")
load("myOauth.Rdata")

####STREAMING DATA####

##Read streaming keywords
lexicon <- readLines("lexicon.csv")

##Convert string to unicode
keyword = stri_trans_nfkc(lexicon)

##Start streaming
filterStream(oauth=my_oauth, timeout = 60, track = keyword, file.name = "tweets.json") ## By seconds

##Save tweets as dataframe
data <- parseTweets("tweets.json", simplify = TRUE, legacy = TRUE)

##View(data)

write_excel_csv(data, "Streamed.csv", col_names = TRUE)

####CLEANING DATA####

##keywords don't reduce it
words2keep <- c("????????", "??????????", "??????????", "??????", "??????????")

##rewrite all Alifs without Hamza
data$text <- fixAlifs(data$text)
##remove all non Arabic or English words
data$text <- cleanChars(data$text)
##remove all English letters
data$text <- cleanLatinChars(data$text)
##remove Arabic numbers
data$text <- removeArabicNumbers(data$text)
##remove Diacritics (tashkeel)
data$text <- removeDiacritics(data$text)
##remove farsi numbers
data$text <- removeFarsiNumbers(data$text)
##remove all numbers
data$text <- removeNumbers(data$text)

##replace ?? to ?? and ?? to ?? and ?? to ??
data$text <- gsub("??", "??", data$text)
data$text <- gsub("??", "??", data$text)
data$text <- gsub("??", "??", data$text)

##reduce multi letters to one letter except words2keep
tmp1 <- paste0('(*UCP)\\b(?:',paste(collapse='|',words2keep),')\\b(*SKIP)(*F)|(\\p{L})\\1+')
data$text <- gsub(tmp1, '\\1',data$text, perl=TRUE)

##remove any one letter alone
data$text <- gsub(" *\\b[?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ?? | ??]{1}\\b *", " ", data$text)

##remove newlines
data$text <- gsub("\\n", " ", data$text)
##remove tabs
data$text <- gsub("\\t", " ", data$text)
##remove arabic letter tatwil (??)
data$text <- gsub("??", "", data$text)
##remove all punctuations except #
data$text <- gsub("([#])|[[:punct:]]", "\\1 ", data$text)

##reduce spaces to one space
data$text <- gsub("([[:space:]])\\1+", "\\1", data$text)
##remove begin and end spaces
data$text <- gsub("^\\s+|\\s+$", "", data$text)


write_excel_csv(data, "Cleaned.csv", col_names = TRUE)


####Spam Filtering####


##Keep keywords
keep <- c( "?????????? ??????????", "?????????? ??????????????", "?????????? ??????", "?????????? ????????", "?????????? ??????????????????", "?????????? ????????", "?????????? ????????", "????????", "????????????", "?????????? ????????????", "?????? ???? ?????? ????????", "???????????? ?????? ???? ?????????????????? ??????????", "???????????? ???????? ???? ??????", "??????????", "???????????? ????????", "?????? ???? ????????", "???????????? ????????",
           
           "??????????????" , "?????????????? ??????????????" , "?????????????? ????????????" , "?????????????? ????????????" , "?????????????? ??????????????" , "???????????? ????????" , "??????????" , "'???????? ??????" , "?????????? ???? ????????" , "?????? ??????" , "???????? ????????????", "???????????? ????????", "???????? ????????????", "???????? ??????????", "???????? ????????????????", "???????????? ??????????", "???????? ????????????")

##spam keywords
spam <- c( "????????", "??????", "??????", "????????????", "????????????????", "??????", "??????????????", "??????????????", "????????", "????????", "????????", "????????????", "????????????", "????????", "????????", "????????", "????????", "??????", "??????????", "????????????", "????????", "??????????????", "????????????", "??????????", "????????????????", "????????", "??????????????", "??????????????", "??????????", "????????", "??????????", "????????????????", "????????????", "????????????????", "??????????", "??????????", "????????????", "????????????", "????????????", "??????????", "????????????", "??????????", "??????????", "??????????", "??????????", "????????????", "????????????", "??????????????", "??????????", "????????", "????????", "??????", "??????????",
           
           "??????????", "??????????", "????????", "??????", "????????", "????????", "????????", "??????????????", "??????????????", "????????", "??????????", "???????????? ", "????????", "??????????????", "????????????????", "??????????????", "??????????????", "??????", "??????????????", "????????????", "??????????????", "????????????", "??????????", "??????", "??????????????", "??????????", "??????????", "????????", "????????????", "????????", "????????", "??????????????", "??????????", "????????????????", "??????", "????????", "????????", "????????", "??????????", "????????", "??????", "????????", "????????", "??????????", "????????", "????????", "??????????", "????????", 
           
           "??????", "????????", "????????", "??????????????", "??????????", "??????", "??????????", "??????????????", "??????????????", "????????????????", "????????????????", "??????????", "????????????", "????????????????", "??????", "????????????", "????????", "??????", "??????????" , "??????????" , "????????????????" , "??????", "????????????" , "????????????????" ,"??????????", "??????????", "??????", "??????", "????????", "??????????", "??????????????" , "??????????" , "??????????????", "??????????", "??????????????????", "????????????", "????????", "??????????", "????????", "????????", "????????", "??????????", "????????????", "????????????", "????????????", "??????????????????", "??????????" ,"??????????" ,"????????????", "????????????" ,"??????????" , 
           
           "????????????" , "??????????????" ,"??????????" ,"??????????????" ,"????????????????????" ,"????????", "????????????????" ,"??????????????" ,"????????????" , "??????", "??????????","??????????????","??????????????" , "????????????" , "????????" ,"??????????" , "??????????????" , "????????" , "????????" , "????????" ,"??????????????" , "????????" , "????????" , "??????????????????","????????", "??????????????", "??????????", "??????????", "????????", " ????????????????", "??????????", "???????????? ", "????????" ,"??????????" ,"??????????????", "????????", "????????", "????????????", "????????" ,"????", "??????????????", "??????????????????" ,"??????????" ,"??????????", "??????????????", "??????????????",
           
           "????????", "????????", "??????????????", "??????????" , "??????????????", "????????????" , "????????" ,"??????????" ,"??????????" ,"??????" ,"?????????????? ", "??????????", "????????", "????????" ,"????????" ,"??????????" ,"????????" ,"????????", "????????????" ,"????????" , "??????????????" ,"????????" , "????????????" , "????????????" ,"????????????" , "??????????" , "?????????? " , "???????? " ,"??????????" ,"??????????", "??????????", "??????", "????????????", "????????????", "????????" , "????????????" , "??????????" ,"??????" ,"????????", "??????????", "??????????" , "????????" ,"??????????" ,"??????????????" ,"??????????" , "????????????" , "????????" , "??????????????" , "??????????" , "??????????????" , "??????" , "????????" , "??????",
           
           "????????" ,"??????????" , "??????" , "????" ,"??????????" ,"????????" , "????????" ,"????????????" ,"????????" , "??????" , "????????" , "????????" , "????????????", "??????????????" ,"????????????" ,"??????????" ,"??????????", "????????????" , "????????" , "??????????????????" , "????????????????" ,"????????????" , "??????????????" , "??????????" , "????????????" , "??????????????", "??????????", "????????", "????????", "??????????", "????????????????", "????????????", "??????????", "????????????????", "??????????????", "??????????", "??????", "??????????", "??????", "??????", "???????? " , "??????????" , "??????" , "????????" , "????????????" , "????????" , "????????" , "??????" , "??????" , "????????" ,
           
           "??????????????" , "??????????" , "????????????" , "????????" , "????????" , "????" , "????????????" , "????????????????" , "???????? ??????????????" , "????" , "??????????" , "????????" ,"??????????", "????????????" , "????????????" , "????????????")


##delete all rows with no Keep keywords
text <- data[grepl(paste(Keep, collapse="|"), data$text),]
data <- as.data.frame(text)

##delete all rows with spam keywords
data <- data[!grepl(paste(spam, collapse="|"), data$text),]

##delete all rows with more than four hashtags
data <- data[sapply(strsplit(as.character(data$text),"#"),length)<4,]
##remove remaining #
data$text <- gsub("#", " ", data$text)


##delete empty rows
data <- data[!grepl("\u009f", data$text),]
data[data == ""] <- NA
data <- data[grepl("", data$text),]

##reduce spaces to one space
data$text <- gsub("([[:space:]])\\1+", "\\1", data$text)
##remove begin and end spaces
data$text <- gsub("^\\s+|\\s+$", "", data$text)

##delete duplicated rows
data <- data[!duplicated(data$text),]
##delete rows with less than two words
data <- data[sapply(strsplit(as.character(data$text)," "),length)>1,]

write_excel_csv(data, "Filtered.csv", col_names = TRUE)


####Removing StopWords####


##stopWords keywords
stopWords <- c( "??????????", "??????", "????????", "????", "??????", "????", "??????", "????", "??????", "????????", "??????", "????????", "????????", "??????????", "????????", "??????????", "??????", "????????", "????", "??????", "????????", "??????????", "????????", "????", "??????", "??????", "????????", "????????", "??????", "????????", "????????", "??????", "????????", "????????", "??????????", "??????", "????", "??????", "????", "??????", "????????", "??????", "??????", "????????", "????", "??????", "??????????", "????????????", "????????????", "??????", "??????????", "??????????", "????????", "????????", "????????", "????", "????????", "??????", "??????", "??????", "????????", "????", "??????", "????", "??????", "??????", "??????", "??????????", "??????", "??????", "????", "??????", "??????", "????",
                
                "??????", "??????????", "??????????", "??????????", "????????????", "????????", "????????", "??????", "????????", "??????", "????????", "????", "??????", "????????", "??????", "??????", "??????", "??????", "??????", "????????", "??????", "????????", "????", "??????", "??????", "??????", "????", "????", "??????", "??????", "????", "??????", "??????", "??????????", "??????", "??????", "??????", "??????", "????", "??????", "????????", "??????", "??????", "????", "??????", "??????", "????????", "??????????", "??????????", "????????", "??????????", "??????", "????", "??????", "??????", "??????????", "??????????", "??????", "??????", "????????", "????????", "??????????", "??????", "????????", "????????", "??????????", "??????", "??????", "????????", "??????",
                
                "????????", "??????", "??????", "????????", "??????", "??????", "??????", "??????????", "????", "??????", "????", "??????", "????????", "??????", "????????", "??????", "????????", "????????", "??????", "??????", "????", "????", "????????", "??????", "??????", "??????????", "??????", "????????", "????", "??????", "????????", "????", "??????", "????", "??????", "??????????", "????", "??????", "????????", "??????????", "??????????", "??????", "??????", "????????", "??????", "??????", "????????", "??????", "????", "??????", "??????", "????????", "??????", "??????????", "????????", "??????????", "??????", "????", "??????", "??????????", "??????", "????", "??????", "????", "??????", "????????", "??????", "????", "????????", "????", "??????", "??????", "????????", "??????", "????", "??????????", "????????", "??????????",
                
                "??????", "??????", "????", "????", "??????", "????????", "????????", "??????????", "??????", "??????", "????", "??????", "??????", "??????", "????????", "????????", "??????????", "????????", "??????", "??????", "??????", "??????", "????", "??????", "??????", "????????", "??????", "??????????", "??????", "????????", "????", "??????", "????", "??????", "????", "??????", "????????", "????", "????????", "????", "??????", "??", "????", "??????", "????????", "??????", "????????", "??????", "????????", "??????", "??????", "??????????", "????????", "??????", "??????", "??????", "??????", "??????", "??????", "????", "????", "??????", "??????", "??", "??????????", "????????", "????", "????", "????????", "????????", "????", "??????", "??????????", "???? ??????", "??????",
                
                "??????", "????????", "????????", "??????", "????", "????")


stopWords <- data.frame(stopWords)

##data$text
##copy text to temp dataframe
tmp <- data$text
##remove stopwords
tmp <- removeWords(tmp, stopWords$stopWords)
##move temp have new text to original file
data$text <- tmp
##remove prefixes
##rowNUM <- 1
##while((is.na(data$text[rowNUM])) != TRUE)
##{
##  data$text[rowNUM] <- removePrefixes(data$text[rowNUM])
##  rowNUM <- rowNUM + 1
##}

##reduce spaces to one space
data$text <- gsub("([[:space:]])\\1+", "\\1", data$text)
##remove begin and end spaces
data$text <- gsub("^\\s+|\\s+$", "", data$text)

write_excel_csv(data, "StopWords Removed.csv", col_names = TRUE)

##To read file
##csvFile <- read.csv(file = "Streamed.csv", header = FALSE, stringsAsFactors=FALSE, encoding = "UTF-8")

##To make wordcloud
Corpus = Corpus(VectorSource(data$text))
wordcloud(Corpus,max.words =100,random.color = TRUE,random.order=FALSE)
